<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="api.js"></script>
</head>
<body>
<form id="from" onsubmit="sendData()">
    <input id="input" type="text" placeholder="Write something...">
    <input id="file-input" type="file">
    <input type="submit">
</form>
<div id="status"></div>
<ul>
    <li id="categories">
    </li>
</ul>
</body>

<script>

    const url = "http://localhost:8080";

	
	/*
	* Созаем обЪект и передаем стратегию WebsocketUpdaterStrategy
	*/
    new Updater(new WebsocketUpdaterStrategy(json => {
        const catElement = document.getElementById("categories");
        catElement.innerHTML = "";
        for (let category of json) {
            const elem = document.createElement("li");
            const a = document.createElement("a");
            a.dataset.id = category.id;
            a.innerText = category.title;
            a.href = url + "/category/" + category.id;
            elem.appendChild(a);
            catElement.appendChild(elem)
        }
    }, url)).start();

	
	
	/*
	* Класс, получает стратегию и вызывает у нее метод start для запуска обновления категорий
	*/
    class Updater {
        constructor(strategy) {
            this.strategy = strategy;
        }

        start() {
            this.strategy.update();
        }
    }

	
	/*
	* Базовый класс стратегии
	*/
    class UpdaterStrategy {

        constructor(callback) {
            this.callback = callback;
        }

        start();
    }

	
	/*
	* Стратегия, которая обновляет категории, используя websocket
	*/
    class WebsocketUpdaterStrategy extends UpdaterStrategy {

        constructor(callback, url) {
            super(callback);
            this.url = url;
        }

        start() {
            const socket = new WebSocket(this.url);

            socket.onopen = function (e) {
                console.log("WebSocket start!");
            };

            socket.onmessage = function (event) {
                callback(event.data);
            }
        }
    }

	/*
	* Стратегия, которая обновляет категории, используя fetch
	*/
    class FetchUpdaterStrategy extends UpdaterStrategy {

        constructor(callback, url) {
            super(callback);
        }

        start() {
            setInterval(() => {
                (async () => {
                    const json = await api(url, 'GET', "/category/", "getting categories", null);
                    this.callback(json);
                })();
            }, 3000);
        }
    }

    async function sendData() {

        event.preventDefault();

        const inputElement = document.getElementById("input");
        const input = inputElement.value;

        const fileInput = document.getElementById("file-input").files[0];
        const formData = new FormData();

        if (fileInput !== undefined) {
            formData.append("file", fileInput)
        }
        await api(url, 'POST', "/data/", "sending data", fileInput === undefined ? input : formData)
    }

    function checkCookie() {
        if (document.cookie === '') {
            window.location.href = "auth.html"
        }
    }

    setInterval(checkCookie, 3000);

</script>
</html>
